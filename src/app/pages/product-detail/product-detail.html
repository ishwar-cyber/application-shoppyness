<!-- ===============================
     PRODUCT DETAIL PAGE
================================ -->
@if (loading()) {
  <div class="product-page loading-state">
    <div class="skeleton skeleton-title"></div>
    <div class="skeleton skeleton-main"></div>
  </div>

}  @else {
  @if (product(); as p) {
    <div class="product-page glass-card" itemscope itemtype="https://schema.org/Product">
      <!-- Breadcrumb -->
      <nav class="breadcrumb">
        <a routerLink="/">Home</a>
        <span>/</span>

        @if (p.category?.slug) {
          <a [routerLink]="['/category', p.category.slug]">
            {{ p.category?.name || 'Category' }}
          </a>
          <span>/</span>
        }

        <span class="current" itemprop="name">{{ p.name }}</span>
      </nav>

      <!-- MAIN LAYOUT -->
      <div class="product-layout">

        <!-- LEFT: GALLERY -->
        <section class="gallery">

          @if (p.images?.length) {
            <div class="thumbs">
              @for (img of p.images; track img.url; let i = $index) {
                <button type="button"
                        class="thumb"
                        [class.active]="i === selectedImageIndex()"
                        (click)="selectImage(i)">
                  <img [src]="img.url" [alt]="p.name" loading="lazy" />
                </button>
              }
            </div>
          }

          <div class="main-image">
            @if (selectedVariant() !== null && selectedVariant()?.image?.[0]?.url) {
              <img [src]="selectedVariant()?.image?.[0]?.url" [alt]="p.name" itemprop="image" />
            } @else {
              <img [src]="selectedImage" [alt]="p.name" itemprop="image" />
            }

            @if (p.images?.length > 1) {
              <button class="nav-btn prev" type="button" (click)="prevImage()">
                <i class="bi bi-chevron-left"></i>
              </button>

              <button class="nav-btn next" type="button" (click)="nextImage()">
                <i class="bi bi-chevron-right"></i>
              </button>
            }
          </div>

        </section>

        <!-- RIGHT: INFO -->
        <section class="info" itemprop="offers" itemscope itemtype="https://schema.org/Offer">

          <h1 class="title">{{ p.name }}</h1>

          <div class="meta-row">
            @if (p.rating) {
              <div class="rating">
                <span class="badge">
                  <i class="bi bi-star-fill"></i>
                  <span>{{ p.rating }}</span>
                </span>
                <span class="muted">{{ p.ratingCount || 0 }} Ratings</span>
              </div>
            }

            <div class="sku-brand">
              @if (p.brand) {
                <span>Brand: <strong>{{ p.brand?.name || p.brand }}</strong></span>
              }

              @if (p.sku) {
                <span>SKU: <strong itemprop="sku">{{ p.sku }}</strong></span>
              }
            </div>
          </div>

          @if (p.variants?.length) {
            <div class="variants">
              <div class="variants-header">
                <span>Available Options</span>
              </div>

              <div class="variant-list">
                @for (v of p.variants; track v._id) {
                  <button type="button"
                          class="variant-chip" [class.active]="selectedVariant()?.['_id'] === v._id"
                          (click)="selectVariant(v)">
                    {{ v.name }}
                  </button>
                }
              </div>
            </div>
          }

          <div class="price-box">

            <div class="left">
              <span class="price" itemprop="price">₹{{ currentPrice() }}</span>
              <meta itemprop="priceCurrency" content="INR" />

              @if (p.oldPrice) {
                <span class="old-price">₹{{ p.oldPrice }}</span>
                <span class="discount">
                  {{ ((p.oldPrice - currentPrice()) / p.oldPrice * 100) | number:'1.0-0' }}% OFF
                </span>
              }
            </div>
            <div class="stock" [class.in-stock]="currentStock() === 'in' ">
              <i class="bi"
                 [class.bi-check-circle]="currentStock() === 'in' "
                 [class.bi-x-circle]="currentStock() !== 'in' "></i>
              <span>{{ currentStock() === 'in'  ? 'In Stock' : 'Out of Stock' }}</span>
            </div>

          </div>

          <!-- Qty + Actions -->
          <div class="qty-actions">

            <div class="qty">
              <span>Qty</span>

              <div class="qty-box">
                <button type="button" (click)="decreaseQty()">-</button>

                <input type="number"
                       [ngModel]="quantity()"
                       (ngModelChange)="quantity.set($event)"
                       min="1" />

                <button type="button" (click)="increaseQty()">+</button>
              </div>
            </div>

            <div class="actions">
              <button class="btn-primary"
                      (click)="addToCart(p)"
                      [disabled]="currentStock() !== 'in' || isAddingToCart()">
                <i class="bi bi-cart-plus"></i>
                @if (!isAddingToCart()) { <span>Add to Cart</span> }
                @else { <span>Adding...</span> }
              </button>
            </div>
          </div>

          @if (isAddingToCart()) {
            <!-- <div class="status-message">{{ addedToCartMessage() }}</div> -->
             <app-loader/>
          }

          @if (p.highlights?.length) {
            <div class="card highlights">
              <h2>Key Highlights</h2>
              <ul>
                @for (h of p.highlights; track h) { <li>{{ h }}</li> }
              </ul>
            </div>
          }

          <div class="card delivery">
            <h2>Delivery</h2>
            <app-check-pincode></app-check-pincode>
          </div>
        </section>
      </div>

      <!-- ==========================
           TABS SECTION
      =========================== -->
      <div class="product-tabs-container">

        <div class="tabs-header">
          <button class="tab-btn"
                  [class.active]="activeTab() === 'description'"
                  (click)="activeTab.set('description')">
            Description
          </button>

          <button class="tab-btn"
                  [class.active]="activeTab() === 'specs'"
                  (click)="activeTab.set('specs')">
            Specifications
          </button>

          <button class="tab-btn"
                  [class.active]="activeTab() === 'reviews'"
                  (click)="activeTab.set('reviews')">
            Reviews
          </button>
        </div>

        <div class="tabs-content">

          <!-- Description -->
          @if (activeTab() === 'description') {
            <div class="tab-pane">
              @if (sanitizedDescription()) {
                <div class="short-desc" [innerHTML]="sanitizedDescription()"></div>
              } @else {
                <p class="muted">No description available.</p>
              }
            </div>
          }

          <!-- Specifications -->
          @if (activeTab() === 'specs') {
            <div class="tab-pane">
              @if (p.specifications?.length) {
                <div class="spec-grid">
                  @for (spec of p.specifications; track spec.name) {
                    <div class="spec-row">
                      <div class="label">{{ spec.name }}</div>
                      <div class="value">{{ spec.value }}</div>
                    </div>
                  }
                </div>
              } @else {
                <p class="muted">No specifications available.</p>
              }
            </div>
          }

          <!-- Reviews -->
          @if (activeTab() === 'reviews') {
            <div class="tab-pane reviews-pane">
              <app-product-review [productId]="p.id"></app-product-review>
            </div>
          }

        </div>
      </div>

      <!-- Related Products -->
      @if (relatedProducts().length) {
        <section class="related">
          <div class="related-header">
            <h2 class="section-title">You may also like</h2>
            <div class="scroll-btns">
              <button type="button" (click)="scrollProducts('left')">
                <i class="bi bi-chevron-left"></i>
              </button>
              <button type="button" (click)="scrollProducts('right')">
                <i class="bi bi-chevron-right"></i>
              </button>
            </div>
          </div>

          <div class="related-row" #relatedProductsScroll>
            @for (rp of relatedProducts(); track rp._id) {
              <app-product-card [product]="rp" class="product-card"></app-product-card>
            }
          </div>
        </section>
      }
    </div>
  }
}
