<div class="container mt-4 mb-5">
  <div class="row">
    <div class="col-12">
      <h1 class="h2 mb-3">Your Cart</h1>
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a routerLink="/">Home</a></li>
          <li class="breadcrumb-item active" aria-current="page">Cart</li>
        </ol>
      </nav>
    </div>
  </div>

  <!-- Loading State with Skeleton Loaders -->
   @if(isLoading()){
        <div>
          <div class="row">
          <!-- Cart Items Section -->
          <div class="col-lg-8">
              <div class="card mb-4">
              <div class="card-header">
                  <div class="skeleton-loader animated-bg" style="height: 24px; width: 120px; border-radius: 4px;"></div>
              </div>
              <div class="card-body p-0">
                  <!-- Skeleton Cart Items -->
                    @for ( i of [1,2,3]; track $index) {
                  <div class="cart-item p-3 border-bottom">
                  <!-- <app-skeleton-loader type="cart-item"></app-skeleton-loader> -->
                  </div>
              }
              </div>
              </div>
          </div>
          
          <!-- Order Summary Section -->
          <div class="col-lg-4">
              <div class="card mb-4">
              <div class="card-header">
                  <div class="skeleton-loader animated-bg" style="height: 24px; width: 150px; border-radius: 4px;"></div>
              </div>
              <div class="card-body">
                  <div class="d-flex justify-content-between mb-3">
                  <div class="skeleton-loader animated-bg" style="height: 18px; width: 80px; border-radius: 4px;"></div>
                  <div class="skeleton-loader animated-bg" style="height: 18px; width: 60px; border-radius: 4px;"></div>
                  </div>
                  <div class="d-flex justify-content-between mb-3">
                  <div class="skeleton-loader animated-bg" style="height: 18px; width: 60px; border-radius: 4px;"></div>
                  <div class="skeleton-loader animated-bg" style="height: 18px; width: 50px; border-radius: 4px;"></div>
                  </div>
                  <div class="d-flex justify-content-between mb-3">
                  <div class="skeleton-loader animated-bg" style="height: 18px; width: 70px; border-radius: 4px;"></div>
                  <div class="skeleton-loader animated-bg" style="height: 18px; width: 55px; border-radius: 4px;"></div>
                  </div>
                  <hr>
                  <div class="d-flex justify-content-between mb-4">
                  <div class="skeleton-loader animated-bg" style="height: 22px; width: 80px; border-radius: 4px;"></div>
                  <div class="skeleton-loader animated-bg" style="height: 22px; width: 70px; border-radius: 4px;"></div>
                  </div>
                  <div class="skeleton-loader animated-bg" style="height: 38px; width: 100%; border-radius: 4px;"></div>
              </div>
              </div>
          </div>
          </div>
        </div>
    }
  <!-- Error State -->
   @if(error()){
  <div class="alert alert-danger" >
    {{ error() }}
    <button type="button" class="btn-close float-end" (click)="error.set(null)"></button>
  </div>
}

  <!-- Empty Cart State -->
   @if(!isLoading() && cartService.cartItems().length === 0 && !error()){
    <div class="empty-cart text-center py-5">
      <div class="empty-cart-icon mb-4">
        <i class="bi bi-cart-x"></i>
      </div>
      <h2>Your cart is empty</h2>
      <p class="text-muted mb-4">Looks like you haven't added any products to your cart yet.</p>
      <a routerLink="/products" class="btn btn-primary">
        Start Shopping
      </a>
    </div>
  }

  <!-- Cart Items Section -->
   @if(!isLoading() && cartService.cartItems().length > 0 && !error()){
      <div class="row">
        <!-- Cart Items List - Left Column -->
        <div class="col-lg-8 mb-4 mb-lg-0">
          <div class="card cart-card">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h5 class="mb-0">Shopping Cart ({{ cartService.cartCount() }} items)</h5>
              <button class="btn btn-sm btn-outline-danger" (click)="clearCart()">Clear All</button>
            </div>
            <div class="card-body p-0">
              <!-- Cart Items -->
              <div class="cart-items">
                <!-- <pre>{{cartService.cartItems() | json}}</pre> -->
                @for (item of cartService.cartItems(); track $index) {
                    <div class="cart-item">
                        <div class="row g-0 align-items-center">
                            <!-- Product Image -->
                            <div class="col-3 col-md-2">
                            <a [routerLink]="['/products', item._id]">
                                <img [src]="item.product.images[0].url" [alt]="item.name" class="cart-item-image">
                            </a>
                            </div>
                            
                            <!-- Product Details -->
                            <div class="col-9 col-md-10">
                            <div class="cart-item-content">
                                <div class="row align-items-center">
                                <div class="col-md-5">
                                    <h5 class="cart-item-title text-truncate" [routerLink]="['/products', item._id]">
                                    {{ item.name }}
                                    </h5>
                                </div>
                                
                                <!-- Quantity Controls -->
                                <div class="col-6 col-md-3">
                                    <div class="quantity-control">
                                    <button class="btn-quantity" (click)="cartService.updateQuantity(item._id, item.quantity - 1)" 
                                            [disabled]="item.quantity <= 1 || updatingItemId === item._id">
                                        <i class="bi bi-dash"></i>
                                    </button>
                                    <input type="number" min="1" [(ngModel)]="item.quantity" 
                                            (change)="cartService.updateQuantity(item._id, item.quantity)" 
                                            class="form-control quantity-input"
                                            [disabled]="updatingItemId === item._id">
                                    <button class="btn-quantity" (click)="cartService.updateQuantity(item._id, item.quantity + 1)" 
                                            [disabled]="updatingItemId === item._id">
                                        <i class="bi bi-plus"></i>
                                    </button>
                                    </div>
                                    <div class="quantity-status small">
                                    @if(updatingItemId === item._id){
                                        <span  class="text-muted">
                                        <i class="bi bi-arrow-repeat spin me-1"></i>Updating...
                                    </span>
                                    }
                                  
                                    </div>
                                </div>
                                
                                <!-- Price and Remove -->
                                <div class="col-6 col-md-4">
                                    <div class="d-flex justify-content-between align-items-center">
                                    <div class="cart-item-price">
                                        <div class="current-price">₹{{ formatCurrency(item.price * item.quantity) }}</div>
                                        <div class="item-price text-muted small">₹{{ formatCurrency(item.price) }} each</div>
                                    </div>
                                    <button class="btn btn-remove" (click)="removeItem(item._id)">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                    </div>
                                </div>
                                </div>
                            </div>
                            </div>
                        </div>
                    </div>
                }
              </div>
            </div>
            <div class="card-footer">
              <div class="d-flex justify-content-between align-items-center">
                <a routerLink="/products" class="btn btn-outline-primary">
                  <i class="bi bi-arrow-left me-2"></i>Continue Shopping
                </a>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Order Summary - Right Column -->
        <div class="col-lg-4">
          <div class="card order-summary-card">
            <div class="card-header">
              <h5 class="mb-0">Order Summary</h5>
            </div>
            <div class="card-body">
              <div class="summary-item d-flex justify-content-between mb-2">
                <span>Subtotal</span>
                <span>₹{{ formatCurrency(cartService.subTotal()) }}</span>
              </div>
              <div class="summary-item d-flex justify-content-between mb-2">
                <span>GST (18%)</span>
                <span>₹{{ formatCurrency(tax()) }}</span>
              </div>
              <div class="summary-item d-flex justify-content-between mb-3">
                <span>Shipping</span>
                @if(shipping() > 0){
                <span>₹{{ formatCurrency(shipping()) }}</span>
                } @else if (shipping() === 0) {
                    <span class="text-success">Free</span>
                }
              </div>
              
              <!-- Coupon Section -->
              <!-- Coupon section allows users to apply discount codes to their order -->
              <div class="coupon-section mb-3">
                <!-- Coupon Input Form - Shown when no coupon is applied -->
                @if(couponCode()){
                      <div class="coupon-form">
                  <div class="input-group">
                    <input 
                      type="text" 
                      class="form-control" 
                      placeholder="Enter coupon code" 
                      [value]="couponInput()"
                      (input)="couponInput.set($any($event.target).value)"
                      [disabled]="isCouponLoading()"
                      (keyup.enter)="applyCoupon()"
                    >
                    <button 
                      class="btn btn-outline-primary" 
                      type="button" 
                      [disabled]="isCouponLoading() || !couponInput()"
                      (click)="applyCoupon()"
                    >
                    @if(!isCouponLoading()){
                      <span >Apply</span>
                    }
                    @if(isCouponLoading()){
                        <span >
                        <span class="spinner-border spinner-border-sm" aria-hidden="true"></span>
                        <span class="visually-hidden">Loading...</span>
                      </span>
                    }
                      
                    </button>
                  </div>
                  @if(couponMessage() && !couponCode()){
                    <div class="coupon-message mt-2" [class.text-danger]="couponError()" [class.text-success]="!couponError()">
                    {{ couponMessage() }}
                  </div>
                  }
                  
                </div>
                }
              
                
                <!-- Applied Coupon Display - Shown when a coupon is successfully applied -->
                @if(couponCode()){
                    <div  class="applied-coupon">
                  <div class="d-flex justify-content-between align-items-center">
                    <div>
                      <span class="badge bg-success me-2">
                        <i class="bi bi-tag-fill me-1"></i>{{ couponCode() }}
                      </span>
                      <span class="text-success">Coupon applied</span>
                    </div>
                    <button class="btn btn-sm btn-link text-danger p-0" (click)="removeCoupon(couponCode())">
                      <i class="bi bi-x-circle"></i> Remove
                    </button>
                  </div>
                  @if(discount() > 0) {
                    <div class="summary-item d-flex justify-content-between mt-2 text-success">
                    <span>Discount</span>
                    <span>-₹{{ formatCurrency(discount()) }}</span>
                  </div>
                  }
                
                </div>
                }
                
              </div>
              
              <hr>
              <div class="summary-total d-flex justify-content-between align-items-center">
                <span>Total</span>
                <span class="total-price">₹{{ formatCurrency(cartService.subTotal()) }}</span>
              </div>
              
              @if(shipping() > 0){
                <div  class="free-shipping-message text-center mt-3">
                    <small class="text-muted">Add ₹{{ formatCurrency(5000 - subtotal()) }} more to get FREE shipping</small>
                </div>
            }
            </div>
            <div class="card-footer">
              <button (click)="checkout()" class="btn btn-primary w-100">
                Proceed to Checkout
              </button>
              <div class="payment-methods text-center mt-3">
                <small class="text-muted">We accept:</small>
                <div class="payment-icons mt-2">
                  <i class="bi bi-credit-card mx-1"></i>
                  <i class="bi bi-wallet2 mx-1"></i>
                  <i class="bi bi-bank mx-1"></i>
                  <i class="bi bi-paypal mx-1"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
   }


  <!-- Mobile Floating Cart Summary Button -->
   @if(!isLoading() && cartService.cartItems().length > 0 && !error()){
    <div class="mobile-cart-summary d-md-none">
      <div class="container">
        <div class="d-flex justify-content-between align-items-center">
          <div class="mobile-total">
            <div class="total-label">Total:</div>
            <div class="total-value">₹{{ formatCurrency(cartService.subTotal()) }}</div>
          </div>
          <button (click)="checkout()" class="btn btn-primary">
            Checkout <i class="bi bi-arrow-right ms-2"></i>
          </button>
        </div>
      </div>
    </div>
   }
</div>