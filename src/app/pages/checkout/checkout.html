<!-- Loading State -->
@if (isLoading()) {
  <div class="container py-4">
    <div class="text-center py-5">
      <div class="spinner-border" aria-hidden="true">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-3">Loading your cart...</p>
    </div>
  </div>
}

<!-- Error State -->
@if (error()) {
  <div class="container py-4">
    <div class="alert alert-danger">
      {{ error() }}
      <button type="button" class="btn-close float-end" (click)="error.set(null)"></button>
    </div>
    <div class="text-center mt-4">
      <a routerLink="/cart" class="btn btn-primary">Return to Cart</a>
    </div>
  </div>
}

<!-- Main Checkout -->
@if (!isLoading() && !error()) {
  <div class="container py-4">
    <div class="row">
      <div class="col-12">
        <h1 class="mb-4">Checkout</h1>
        <!-- Checkout Progress -->
        <div class="checkout-progress mb-4">
          <div class="step" [class.active]="currentStep() >= 1" [class.completed]="currentStep() > 1">
            <div class="step-number">1</div>
            <div class="step-label">Shipping</div>
          </div>
          <div class="step-connector"></div>
          <div class="step" [class.active]="currentStep() >= 2" [class.completed]="currentStep() > 2">
            <div class="step-number">2</div>
            <div class="step-label">Billing</div>
          </div>
          <div class="step-connector"></div>
          <div class="step" [class.active]="currentStep() >= 3">
            <div class="step-number">3</div>
            <div class="step-label">Payment</div>
          </div>
        </div>
      </div>
    </div>

    <div class="row">
      <!-- Checkout Form -->
      <div class="col-lg-8">
        <div class="card mb-4">
          <div class="card-body">
            @if (currentStep() === 1) {
              <app-shipping
                (continue)="nextStep()">
              </app-shipping>
            }
            @if (currentStep() === 2) {
              <app-billing
                [addresses]="addresses()"
                [selectedAddressId]="selectedAddressId()"
                (addressChange)="setAddress($event)"
                (addAddress)="addAddress($event)"
                (continue)="nextStep()">
              </app-billing>
            }
          
            @if (currentStep() === 3) {
                <!-- Order Summary -->
                <div class="col-lg-4">
                  <div class="card order-summary-card mb-4">
                    <div class="card-header">
                      <h5 class="mb-0">Order Summary</h5>
                    </div>
                    <div class="card-body">
                      <div class="cart-items-summary">
                          <div class="cart-item-summary">
                        @for(item of cartService.cartItems(); track $index){

                                <div class="d-flex justify-content-between align-items-center mb-2">
                                  <div class="item-details d-flex align-items-center">
                                    <img [src]="item.product.images[0].url" width="100px" height="100px" [alt]="item.name" class="item-thumbnail me-2" loading="lazy">
                                    <div>
                                      <div class="item-name">{{ item.name }}</div>
                                      <div class="item-quantity text-muted small">Qty: {{ item.quantity }}</div>
                                    </div>
                                  </div>
                                  <div class="item-price">₹{{ formatCurrency(item.price * item.quantity) }}</div>
                                </div>
                            }

                          </div>

                      </div>

                      <hr>

                      <!-- Pricing Breakdown -->
                      <div class="price-summary">
                          <!-- Coupon Section -->
                        <!-- Coupon section allows users to apply discount codes to their order -->
                        <div class="coupon-section mb-3">
                          <!-- Coupon Input Form - Shown when no coupon is applied -->
                          @if(true){
                          <div class="coupon-form">
                            <div class="input-group">
                              <input 
                                type="text" 
                                class="form-control" 
                                placeholder="Enter coupon code" 
                                [value]="couponInput()"
                                (input)="couponInput.set($any($event.target).value)"
                                [disabled]="isCouponLoading()"
                                (keyup.enter)="applyCoupon()"
                              >
                              <button 
                                class="btn btn-outline-primary" 
                                type="button" 
                                [disabled]="isCouponLoading() || !couponInput()"
                                (click)="applyCoupon()"
                              >
                              @if(!isCouponLoading()){
                                <span >Apply</span>
                              }
                              @if(isCouponLoading()){
                                  <span >
                                  <span class="spinner-border spinner-border-sm" aria-hidden="true"></span>
                                  <span class="visually-hidden">Loading...</span>
                                </span>
                              }
                                
                              </button>
                            </div>
                            @if(couponMessage() && !couponCode()){
                              <div class="coupon-message mt-2" [class.text-danger]="couponError()" [class.text-success]="!couponError()">
                              {{ couponMessage() }}
                            </div>
                            }
                            
                          </div>
                          }
                        
                          
                          <!-- Applied Coupon Display - Shown when a coupon is successfully applied -->
                          @if(couponCode()){
                              <div  class="applied-coupon">
                            <div class="d-flex justify-content-between align-items-center">
                              <div>
                                <span class="badge bg-success me-2">
                                  <i class="bi bi-tag-fill me-1"></i>{{ couponCode() }}
                                </span>
                                <span class="text-success">Coupon applied</span>
                              </div>
                              <button class="btn btn-sm btn-link text-danger p-0" (click)="removeCoupon(couponCode())">
                                <i class="bi bi-x-circle"></i> Remove
                              </button>
                            </div>
                            @if(discount() > 0) {
                              <div class="summary-item d-flex justify-content-between mt-2 text-success">
                              <span>Discount</span>
                              <span>-₹{{ formatCurrency(discount()) }}</span>
                            </div>
                            }
                          
                          </div>
                          }
                          
                        </div>
                        <div class="summary-item d-flex justify-content-between mb-2">
                          <span>Subtotal</span>
                          <span>₹{{ formatCurrency(cartService.subTotal()) }}</span>
                        </div>
                        <div class="summary-item d-flex justify-content-between mb-2">
                          <span>Shipping Charges  </span>
                          @if (shipping() > 0) {
                            <span>₹{{ formatCurrency(shipping()) }}</span>
                          }
                        </div>
                        @if (selectedPaymentMethod() === 'cod' && currentStep() === 3) {
                          <div class="summary-item d-flex justify-content-between mb-2">
                            <span>Cash on Delivery Fee</span>
                            <span>₹50</span>
                          </div>
                        }
                        <hr>
                        <div class="summary-total d-flex justify-content-between align-items-center">
                          <span>Total</span>
                          <span class="total-price">
                            ₹{{ formatCurrency(cartService.subTotal() + (selectedPaymentMethod() === 'cod' && currentStep() === 3 ? 50 : 0)) }}
                          </span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <!-- <app-payment (back)="prevStep()" [amount]="totalAmount()" ></app-payment> -->
                <div class="d-flex justify-content-between">
                  <button class="btn btn-outline-secondary" (click)="prevStep()" [disabled]="isProcessing()">
                    &larr; Back
                  </button>
                  <button class="btn btn-primary" (click)="placeOrder()" [disabled]="isProcessing() || !selectedAddressId()">
                    @if(!isProcessing()){
                      Place Order &rarr;
                    } @else if(isProcessing()){
                      <span >
                        <span class="spinner-border spinner-border-sm" aria-hidden="true"></span>
                        <span class="visually-hidden">Loading...</span>
                      </span>
                    }
                  </button>
                </div>
              }
          </div>
        </div>
      </div>
    </div>
  </div>
}


<!-- Order Confirmation -->
@if (isOrderComplete() && orderResponse()) {
  <app-order-success 
    [show]="isOrderComplete()"
    [order]="orderResponse()"
    (close)="isOrderComplete.set(false)">
  </app-order-success>
}
