<h4 class="mb-3">Select Delivery Address</h4>

<div class="list-group mb-3">
  @for (addr of addresses(); track addr.id) {
    <label class="list-group-item d-flex gap-2 align-items-start">
      <input
        type="radio"
        name="address"
        class="form-check-input mt-1"
        [checked]="addr.id === selectedAddressId()"
        (change)="onSelectAddress(addr.id)" />
      <div>
        <div class="fw-semibold">{{ addr.name }} â€” {{ addr.phone }}</div>
        <div class="text-muted small">
          {{ addr.addressLine1 }}, {{ addr.addressLine2 }} <br />
          {{ addr.landmark }}, {{ addr.city }}, {{ addr.state }} - {{ addr.pincode }} <br />
          {{ addr.country }}
        </div>
      </div>
    </label>
  }
</div>

<button class="btn btn-outline-primary mb-3" (click)="showForm.set(true)">
  + Add New Address
</button>

<!-- Address Form -->
@if (showForm()) {
  <div class="card p-3 mb-3">
    <form [formGroup]="form" (ngSubmit)="onSaveAddress()">
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Name</label>
          <input class="form-control" formControlName="name" />
          @if (form.get('name')?.touched && form.get('name')?.invalid) {
            <div class="text-danger small">Name is required (min 2 chars)</div>
          }
        </div>

        <div class="col-md-6">
          <label class="form-label">Phone</label>
          <input class="form-control" formControlName="phone" />
          @if (form.get('phone')?.touched && form.get('phone')?.invalid) {
            <div class="text-danger small">Enter a valid 10-digit phone</div>
          }
        </div>

        <div class="col-12">
          <label class="form-label">Address Line 1</label>
          <input class="form-control" formControlName="addressLine1" />
        </div>

        <div class="col-12">
          <label class="form-label">Address Line 2</label>
          <input class="form-control" formControlName="addressLine2" />
        </div>

        <div class="col-md-6">
          <label class="form-label">Landmark</label>
          <input class="form-control" formControlName="landmark" />
        </div>

        <div class="col-md-6">
          <label class="form-label">City</label>
          <input class="form-control" formControlName="city" />
        </div>

        <div class="col-md-6 position-relative">
          <label class="form-label">State</label>
          <input
            type="text"
            class="form-control" (focus)="openStateSearch.set(true)"
            [value]="searchState()"
            (input)="filterStates($event)"
            placeholder="Search state..."
          />
          @if(openStateSearch()){
             <div class="list-group position-absolute w-100 shadow-sm">
              @for (state of filteredStates(); track state) {
                <button type="button"
                  class="list-group-item list-group-item-action"
                  (click)="form.get('state')?.setValue(state); searchState.set(state); filteredStates.set([])">
                  {{ state }}
                </button>
              } @empty {
               <button type="button"
                  class="list-group-item list-group-item-action"
                >State not found                </button>
              }
            </div>
          }
         
        </div>

        <div class="col-md-6">
          <label class="form-label">Pincode</label>
          <input class="form-control" formControlName="pincode" />
        </div>

        <div class="col-md-6">
          <label class="form-label">Country</label>
          <input class="form-control" formControlName="country" readonly />
        </div>
      </div>

      <div class="d-flex justify-content-end gap-2 mt-3">
        <button type="button" class="btn btn-light" (click)="showForm.set(false)">Cancel</button>
        <button type="submit" class="btn btn-success" [disabled]="form.invalid">Save Address</button>
      </div>
    </form>
  </div> 
}

<div class="text-end mt-3">
  <button class="btn btn-primary" [disabled]="!selectedAddressId()" (click)="continue.emit()">
    Continue
  </button>
</div>
