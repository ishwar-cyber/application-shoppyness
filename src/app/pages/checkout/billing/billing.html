<h4 class="mb-3">Select Delivery Address</h4>

<div class="list-group mb-3">
  @for (addr of addressesList(); track addr.id) {
    <label class="list-group-item d-flex gap-2 align-items-start">
      <input
        type="radio"
        name="address"
        class="form-check-input mt-1"
        [checked]="addr.id === selectedAddress()?.id"
        (change)="onSelectAddress(addr.id)" />
      <div>
        <div class="fw-semibold">{{ addr.fullName }} â€” {{ addr.phone }}</div>
        <div class="text-muted small">
          {{ addr.line1 }}, {{ addr.line2 }} <br />
          {{ addr.landmark }}, {{ addr.city }}, {{ addr.state }} - {{ addr.pincode }} <br />
          {{ addr.country }}
        </div>
      </div>
    </label>
  }
</div>

<button class="btn btn-outline-primary mb-3" (click)="showForm.set(true)">
  + Add New Address
</button>

<!-- Address Form -->
@if (showForm()) {
  <div class="card p-3 mb-3">
    <form [formGroup]="addressForm">
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Name</label>
          <input class="form-control" formControlName="fullName" type="text"/>
          @if (addressForm.get('fullName')?.touched && addressForm.get('fullName')?.invalid) {
            <div class="text-danger small">Name is required (min 2 chars)</div>
          }
        </div>

        <div class="col-md-6">
          <label class="form-label">Phone</label>
          <input class="form-control" formControlName="phone"  type="tel" minlength="10" maxlength="10"/>
          @if (addressForm.get('phone')?.touched && addressForm.get('phone')?.invalid) {
            <div class="text-danger small">Enter a valid 10-digit phone</div>
          }
        </div>

        <div class="col-12">
          <label class="form-label">Address Line 1</label>
          <input class="form-control" formControlName="line1" type="text" />
        </div>

        <div class="col-12">
          <label class="form-label">Address Line 2</label>
          <input class="form-control" formControlName="line2" type="text" />
        </div>

        <div class="col-md-6">
          <label class="form-label">Landmark</label>
          <input class="form-control" formControlName="landmark" type="text" />
        </div>

        <div class="col-md-6">
          <label class="form-label">City</label>
          <input class="form-control" formControlName="city" type="text" />
        </div>

        <div class="col-md-6 position-relative">
          <label class="form-label">State</label>
          <input
            type="text"
            class="form-control" (focus)="openStateSearch.set(true)"
            [value]="searchState()"
            (input)="filterStates($event)"
            placeholder="Search state..."
          />
          @if(openStateSearch()){
             <div class="list-group position-absolute w-100 shadow-sm">
              @for (state of filteredStates(); track state) {
                <button type="button" class="list-group-item list-group-item-action"
                  (click)="addressForm.get('state')?.setValue(state); searchState.set(state); openStateSearch.set(false)"> {{ state }}
                </button>
              } @empty {
                <button type="button" class="list-group-item list-group-item-action"> State not found </button>
              }
            </div>
          }
        </div>

        <div class="col-md-6">
          <label class="form-label">Pincode</label>
          <input class="form-control" formControlName="pincode" type="text" maxlength="6" />
        </div>

        <div class="col-md-6">
          <label class="form-label">Country</label>
          <input class="form-control" formControlName="country" readonly />
        </div>
      </div>

      <div class="d-flex justify-content-end gap-2 mt-3">
        <button type="button" class="btn btn-light" (click)="showForm.set(false)">Cancel</button>
        <button type="submit" class="btn btn-success" [disabled]="addressForm.invalid" (click)="saveAddress()">Save Address</button>
      </div>
    </form>
  </div> 
}

<div class="text-end mt-3">
  <button class="btn btn-primary" [disabled]="addressesList().length === 0" (click)="continue.emit()">
    Continue
  </button>
</div>
